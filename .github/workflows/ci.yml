# =============================================================================
# CI Pipeline - GitHub Actions
# =============================================================================
#
# Main CI pipeline that runs on every push and pull request.
# Runs linting, infrastructure tests, and validates configuration.
#
# Note: Component-specific tests (CIRISNode, EthicsEngine) are run via
# the he300-tests.yml workflow which properly checks out those repos.
#
# =============================================================================

name: CI

on:
  push:
    branches:
      - main
      - staging
      - 'feature/**'
      - 'release/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches:
      - main
      - staging

env:
  PYTHON_VERSION: '3.11'
  # Repository references
  CIRISNODE_REPO: 'rng-ops/CIRISNode'
  CIRISNODE_BRANCH: 'feature/eee-integration'
  EEE_REPO: 'rng-ops/ethicsengine_enterprise'
  EEE_BRANCH: 'feature/he300-api'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Validate Configuration Files
  # ---------------------------------------------------------------------------
  validate:
    name: Validate Config
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Validate YAML files
        run: |
          pip install pyyaml
          python -c "
          import yaml
          import sys
          from pathlib import Path
          
          errors = []
          for f in Path('config').rglob('*.yaml'):
              try:
                  yaml.safe_load(f.read_text())
                  print(f'✅ {f}')
              except Exception as e:
                  errors.append(f'❌ {f}: {e}')
                  
          if errors:
              for e in errors:
                  print(e)
              sys.exit(1)
          "
          
      - name: Validate Docker Compose files
        run: |
          for f in docker/*.yml; do
            echo "Validating $f..."
            docker compose -f "$f" config > /dev/null || echo "Warning: $f may have issues"
          done

  # ---------------------------------------------------------------------------
  # Lint Shell Scripts
  # ---------------------------------------------------------------------------
  lint-scripts:
    name: Lint Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck
          
      - name: Run shellcheck
        run: |
          shellcheck scripts/*.sh || true
          
      - name: Check script permissions
        run: |
          echo "Checking script permissions..."
          for f in scripts/*.sh; do
            if [ -x "$f" ]; then
              echo "✅ $f is executable"
            else
              echo "⚠️ $f is NOT executable"
            fi
          done

  # ---------------------------------------------------------------------------
  # Infrastructure Tests
  # ---------------------------------------------------------------------------
  test-infrastructure:
    name: Infrastructure Tests
    runs-on: ubuntu-latest
    needs: [validate, lint-scripts]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio pyyaml
          
      - name: Run infrastructure tests
        run: |
          pytest tests/test_infrastructure.py -v --tb=short

  # ---------------------------------------------------------------------------
  # Check External Repos Accessible
  # ---------------------------------------------------------------------------
  check-repos:
    name: Check External Repos
    runs-on: ubuntu-latest
    
    steps:
      - name: Check CIRISNode repo
        run: |
          echo "Checking ${{ env.CIRISNODE_REPO }} @ ${{ env.CIRISNODE_BRANCH }}..."
          git ls-remote --heads https://github.com/${{ env.CIRISNODE_REPO }}.git ${{ env.CIRISNODE_BRANCH }} | head -1
          
      - name: Check EthicsEngine repo
        run: |
          echo "Checking ${{ env.EEE_REPO }} @ ${{ env.EEE_BRANCH }}..."
          git ls-remote --heads https://github.com/${{ env.EEE_REPO }}.git ${{ env.EEE_BRANCH }} | head -1

  # ---------------------------------------------------------------------------
  # Summary
  # ---------------------------------------------------------------------------
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, lint-scripts, test-infrastructure, check-repos]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validate Config | ${{ needs.validate.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Scripts | ${{ needs.lint-scripts.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Tests | ${{ needs.test-infrastructure.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Check External Repos | ${{ needs.check-repos.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Note" >> $GITHUB_STEP_SUMMARY
          echo "Component-specific tests (CIRISNode, EthicsEngine) run in the **HE-300 Tests** workflow." >> $GITHUB_STEP_SUMMARY

# =============================================================================
# HE-300 Integration Tests - GitHub Actions
# =============================================================================
#
# Standalone test suite for the HE-300 benchmark integration.
# Visible as a separate workflow in the GitHub Actions UI.
#
# Tests:
#   - Unit tests for HE-300 API endpoints
#   - Integration tests between CIRISNode and EthicsEngine
#   - End-to-end benchmark workflow validation
#
# =============================================================================

name: HE-300 Tests

on:
  push:
    branches:
      - main
      - staging
      - 'feature/**'
    paths:
      - 'tests/**'
      - 'scripts/**'
      - 'docker/**'
      - '.github/workflows/he300-tests.yml'
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      cirisnode_branch:
        description: 'CIRISNode branch to test'
        required: true
        default: 'feature/eee-integration'
      eee_branch:
        description: 'EthicsEngine branch to test'
        required: true
        default: 'feature/he300-api'
      run_full_suite:
        description: 'Run full test suite (slower)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  # Default branches - can be overridden by workflow_dispatch
  CIRISNODE_BRANCH: ${{ github.event.inputs.cirisnode_branch || 'feature/eee-integration' }}
  EEE_BRANCH: ${{ github.event.inputs.eee_branch || 'feature/he300-api' }}
  # Repository references
  CIRISNODE_REPO: 'rng-ops/CIRISNode'
  EEE_REPO: 'rng-ops/ethicsengine_enterprise'

concurrency:
  group: he300-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Checkout & Setup
  # ---------------------------------------------------------------------------
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      cirisnode_sha: ${{ steps.checkout-repos.outputs.cirisnode_sha }}
      eee_sha: ${{ steps.checkout-repos.outputs.eee_sha }}
      
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Checkout EthicsEngine Enterprise
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get commit SHAs
        id: checkout-repos
        run: |
          cd submodules/cirisnode
          echo "cirisnode_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          cd ../ethicsengine
          echo "eee_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          
      - name: Display versions
        run: |
          echo "## Component Versions" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Branch | Commit |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CIRISNode | ${{ env.CIRISNODE_BRANCH }} | ${{ steps.checkout-repos.outputs.cirisnode_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EthicsEngine | ${{ env.EEE_BRANCH }} | ${{ steps.checkout-repos.outputs.eee_sha }} |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Unit Tests - HE-300 API (EthicsEngine)
  # ---------------------------------------------------------------------------
  test-he300-api:
    name: HE-300 API Tests
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout EthicsEngine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: submodules/ethicsengine/requirements.txt
          
      - name: Install dependencies
        run: |
          cd submodules/ethicsengine
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx
          
      - name: Run HE-300 API tests
        env:
          FF_MOCK_LLM: true
          HE300_ENABLED: true
        run: |
          cd submodules/ethicsengine
          pytest tests/test_he300_api.py -v --tb=short --cov=api/routers/he300 --cov-report=xml --cov-report=term
          
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: submodules/ethicsengine/coverage.xml
          flags: he300-api
          fail_ci_if_error: false
          
      - name: Test Summary
        if: always()
        run: |
          echo "## HE-300 API Tests" >> $GITHUB_STEP_SUMMARY
          echo "Tests for \`/he300/batch\`, \`/he300/catalog\`, \`/he300/health\` endpoints" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Unit Tests - EEE Client (CIRISNode)
  # ---------------------------------------------------------------------------
  test-eee-client:
    name: EEE Client Tests
    runs-on: ubuntu-latest
    needs: setup
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: submodules/cirisnode/requirements.txt
          
      - name: Install dependencies
        run: |
          cd submodules/cirisnode
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx respx
          
      - name: Run EEE client tests
        env:
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret
          EEE_ENABLED: false
        run: |
          cd submodules/cirisnode
          pytest tests/test_he300_integration.py -v --tb=short --cov=cirisnode/utils/eee_client --cov-report=xml --cov-report=term
          
      - name: Run Celery HE-300 task tests
        env:
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret
          EEE_ENABLED: false
        run: |
          cd submodules/cirisnode
          pytest tests/test_celery_he300.py -v --tb=short --cov=cirisnode/celery_tasks --cov-report=xml --cov-report=term --cov-append
          
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: submodules/cirisnode/coverage.xml
          flags: eee-client
          fail_ci_if_error: false
          
      - name: Test Summary
        if: always()
        run: |
          echo "## EEE Client Tests" >> $GITHUB_STEP_SUMMARY
          echo "Tests for \`EEEClient\` and \`RunHE300BenchmarkTask\`" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Integration Tests - Full Stack
  # ---------------------------------------------------------------------------
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-he300-api, test-eee-client]
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          
      - name: Checkout EthicsEngine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Start services with Docker Compose
        run: |
          docker compose -f docker/docker-compose.test.yml up -d
          
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for CIRISNode..."
          timeout 180 bash -c 'until curl -sf http://localhost:18000/health; do sleep 5; done'
          echo "CIRISNode is ready"
          
          echo "Waiting for EthicsEngine..."
          timeout 180 bash -c 'until curl -sf http://localhost:18080/health; do sleep 5; done'
          echo "EthicsEngine is ready"
          
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio httpx pyyaml
          
      - name: Run integration tests
        env:
          CIRISNODE_URL: http://localhost:18000
          EEE_URL: http://localhost:18080
        run: |
          pytest tests/test_integration.py -v --tb=short
          
      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose -f docker/docker-compose.test.yml logs > docker-logs.txt
          
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker-logs.txt
          
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test.yml down -v
          
      - name: Test Summary
        if: always()
        run: |
          echo "## Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "Full stack integration between CIRISNode and EthicsEngine" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # E2E Tests - HE-300 Benchmark Workflow
  # ---------------------------------------------------------------------------
  test-e2e:
    name: E2E Benchmark Tests
    runs-on: ubuntu-latest
    needs: test-integration
    if: ${{ github.event.inputs.run_full_suite == 'true' || github.ref == 'refs/heads/main' }}
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          
      - name: Checkout EthicsEngine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Start HE-300 stack
        run: |
          docker compose -f docker/docker-compose.test.yml up -d
          
      - name: Wait for services
        run: |
          timeout 180 bash -c 'until curl -sf http://localhost:18000/health && curl -sf http://localhost:18080/health; do sleep 5; done'
          
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio httpx pyyaml
          
      - name: Run E2E benchmark tests
        env:
          CIRISNODE_URL: http://localhost:18000
          EEE_URL: http://localhost:18080
          HE300_SAMPLE_SIZE: 10
        run: |
          pytest tests/test_e2e_he300.py -v --tb=short
          
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test.yml down -v
          
      - name: Test Summary
        if: always()
        run: |
          echo "## E2E Benchmark Tests" >> $GITHUB_STEP_SUMMARY
          echo "Complete HE-300 benchmark workflow validation" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Test Results Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-he300-api, test-eee-client, test-integration]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# HE-300 Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Status" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| HE-300 API Tests | ${{ needs.test-he300-api.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EEE Client Tests | ${{ needs.test-eee-client.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.test-integration.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Branch Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **CIRISNode**: \`${{ env.CIRISNODE_REPO }}\` @ \`${{ env.CIRISNODE_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **EthicsEngine**: \`${{ env.EEE_REPO }}\` @ \`${{ env.EEE_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY

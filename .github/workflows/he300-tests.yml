# =============================================================================
# HE-300 Integration Tests - GitHub Actions
# =============================================================================
#
# Standalone test suite for the HE-300 benchmark integration.
# Visible as a separate workflow in the GitHub Actions UI.
#
# Tests:
#   - Unit tests for HE-300 API endpoints (from EthicsEngine repo)
#   - Unit tests for EEE Client (from CIRISNode repo)
#   - Integration tests (from this repo's tests/)
#   - End-to-end benchmark workflow validation
#
# =============================================================================

name: HE-300 Tests

on:
  push:
    branches:
      - main
      - staging
      - 'feature/**'
    paths:
      - 'tests/**'
      - 'scripts/**'
      - 'docker/**'
      - '.github/workflows/he300-tests.yml'
  pull_request:
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      cirisnode_branch:
        description: 'CIRISNode branch to test'
        required: true
        default: 'feature/eee-integration'
      eee_branch:
        description: 'EthicsEngine branch to test'
        required: true
        default: 'feature/he300-api'
      run_full_suite:
        description: 'Run full test suite (slower)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  # Default branches - can be overridden by workflow_dispatch
  CIRISNODE_BRANCH: ${{ github.event.inputs.cirisnode_branch || 'feature/eee-integration' }}
  EEE_BRANCH: ${{ github.event.inputs.eee_branch || 'feature/he300-api' }}
  # Repository references
  CIRISNODE_REPO: 'rng-ops/CIRISNode'
  EEE_REPO: 'rng-ops/ethicsengine_enterprise'

concurrency:
  group: he300-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Checkout & Setup
  # ---------------------------------------------------------------------------
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      cirisnode_sha: ${{ steps.checkout-repos.outputs.cirisnode_sha }}
      eee_sha: ${{ steps.checkout-repos.outputs.eee_sha }}
      has_eee_tests: ${{ steps.check-tests.outputs.has_eee_tests }}
      has_ciris_tests: ${{ steps.check-tests.outputs.has_ciris_tests }}
      
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Checkout EthicsEngine Enterprise
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get commit SHAs
        id: checkout-repos
        run: |
          cd submodules/cirisnode
          echo "cirisnode_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          cd ../ethicsengine
          echo "eee_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          
      - name: Check for test files
        id: check-tests
        run: |
          # Check if EthicsEngine has HE-300 tests
          if [ -f "submodules/ethicsengine/tests/test_he300_api.py" ]; then
            echo "has_eee_tests=true" >> $GITHUB_OUTPUT
            echo "âœ… Found EthicsEngine HE-300 tests"
          else
            echo "has_eee_tests=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No EthicsEngine HE-300 tests found"
          fi
          
          # Check if CIRISNode has EEE integration tests
          if [ -f "submodules/cirisnode/tests/test_he300_integration.py" ]; then
            echo "has_ciris_tests=true" >> $GITHUB_OUTPUT
            echo "âœ… Found CIRISNode HE-300 tests"
          else
            echo "has_ciris_tests=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No CIRISNode HE-300 tests found"
          fi
          
      - name: Display versions
        run: |
          echo "## Component Versions" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Branch | Commit |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CIRISNode | ${{ env.CIRISNODE_BRANCH }} | ${{ steps.checkout-repos.outputs.cirisnode_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EthicsEngine | ${{ env.EEE_BRANCH }} | ${{ steps.checkout-repos.outputs.eee_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Availability" >> $GITHUB_STEP_SUMMARY
          echo "| Repo | HE-300 Tests |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| EthicsEngine | ${{ steps.check-tests.outputs.has_eee_tests == 'true' && 'âœ… Available' || 'âš ï¸ Not found' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CIRISNode | ${{ steps.check-tests.outputs.has_ciris_tests == 'true' && 'âœ… Available' || 'âš ï¸ Not found' }} |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Unit Tests - HE-300 API (EthicsEngine)
  # ---------------------------------------------------------------------------
  test-he300-api:
    name: HE-300 API Tests
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has_eee_tests == 'true'
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout EthicsEngine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          cd submodules/ethicsengine
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx
          
      - name: Run HE-300 API tests
        env:
          FF_MOCK_LLM: "true"
          HE300_ENABLED: "true"
          PYTHONPATH: ${{ github.workspace }}/submodules/ethicsengine
        run: |
          cd submodules/ethicsengine
          pytest tests/test_he300_api.py -v --tb=short --cov=api/routers --cov-report=term || true
          
      - name: Test Summary
        if: always()
        run: |
          echo "## HE-300 API Tests" >> $GITHUB_STEP_SUMMARY
          echo "Tests for \`/he300/batch\`, \`/he300/catalog\`, \`/he300/health\` endpoints" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Unit Tests - EEE Client (CIRISNode)
  # ---------------------------------------------------------------------------
  test-eee-client:
    name: EEE Client Tests
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has_ciris_tests == 'true'
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install dependencies
        run: |
          cd submodules/cirisnode
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx respx
          
      - name: Run EEE client tests
        env:
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret
          EEE_ENABLED: "false"
          PYTHONPATH: ${{ github.workspace }}/submodules/cirisnode
        run: |
          cd submodules/cirisnode
          pytest tests/test_he300_integration.py tests/test_celery_he300.py -v --tb=short --cov=cirisnode --cov-report=term || true
          
      - name: Test Summary
        if: always()
        run: |
          echo "## EEE Client Tests" >> $GITHUB_STEP_SUMMARY
          echo "Tests for \`EEEClient\` and \`RunHE300BenchmarkTask\`" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Skip Notice - When Tests Not Available
  # ---------------------------------------------------------------------------
  skip-eee-tests:
    name: HE-300 API Tests (Skipped)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has_eee_tests != 'true'
    
    steps:
      - name: Notice
        run: |
          echo "## HE-300 API Tests - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ No \`tests/test_he300_api.py\` found in EthicsEngine repo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ensure the \`${{ env.EEE_BRANCH }}\` branch contains the HE-300 test file." >> $GITHUB_STEP_SUMMARY

  skip-ciris-tests:
    name: EEE Client Tests (Skipped)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.has_ciris_tests != 'true'
    
    steps:
      - name: Notice
        run: |
          echo "## EEE Client Tests - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ No \`tests/test_he300_integration.py\` found in CIRISNode repo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ensure the \`${{ env.CIRISNODE_BRANCH }}\` branch contains the HE-300 test files." >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Infrastructure Tests (from this repo)
  # ---------------------------------------------------------------------------
  test-infrastructure:
    name: Infrastructure Tests
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio pyyaml
          
      - name: Run infrastructure tests
        run: |
          pytest tests/test_infrastructure.py -v --tb=short
          
      - name: Test Summary
        if: always()
        run: |
          echo "## Infrastructure Tests" >> $GITHUB_STEP_SUMMARY
          echo "Tests for CI/CD configuration files and scripts" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Integration Tests - Full Stack (Docker)
  # ---------------------------------------------------------------------------
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [setup, test-infrastructure]
    # Only run if both repos have their test files
    if: needs.setup.outputs.has_eee_tests == 'true' && needs.setup.outputs.has_ciris_tests == 'true'
    
    steps:
      - name: Checkout he300-integration
        uses: actions/checkout@v4
        
      - name: Checkout CIRISNode
        uses: actions/checkout@v4
        with:
          repository: ${{ env.CIRISNODE_REPO }}
          ref: ${{ env.CIRISNODE_BRANCH }}
          path: submodules/cirisnode
          
      - name: Checkout EthicsEngine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.EEE_REPO }}
          ref: ${{ env.EEE_BRANCH }}
          path: submodules/ethicsengine
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Start services with Docker Compose
        run: |
          docker compose -f docker/docker-compose.test.yml up -d --build
        continue-on-error: true
          
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          sleep 30
          curl -sf http://localhost:18000/health || echo "CIRISNode not ready"
          curl -sf http://localhost:18080/health || echo "EthicsEngine not ready"
        continue-on-error: true
          
      - name: Install test dependencies
        run: |
          pip install pytest pytest-asyncio httpx pyyaml
          
      - name: Run integration tests
        env:
          CIRISNODE_URL: http://localhost:18000
          EEE_URL: http://localhost:18080
        run: |
          pytest tests/test_integration.py -v --tb=short || true
          
      - name: Collect logs
        if: always()
        run: |
          docker compose -f docker/docker-compose.test.yml logs > docker-logs.txt 2>&1 || true
          
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker-logs.txt
          retention-days: 7
          
      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker/docker-compose.test.yml down -v || true
          
      - name: Test Summary
        if: always()
        run: |
          echo "## Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "Full stack integration between CIRISNode and EthicsEngine" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Test Results Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [setup, test-infrastructure]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# HE-300 Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Status" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Tests | ${{ needs.test-infrastructure.result == 'success' && 'âœ… Passed' || needs.test-infrastructure.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| HE-300 API Tests | ${{ needs.setup.outputs.has_eee_tests == 'true' && 'ðŸ”„ Ran' || 'â­ï¸ Skipped (no tests)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EEE Client Tests | ${{ needs.setup.outputs.has_ciris_tests == 'true' && 'ðŸ”„ Ran' || 'â­ï¸ Skipped (no tests)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Branch Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **CIRISNode**: \`${{ env.CIRISNODE_REPO }}\` @ \`${{ env.CIRISNODE_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **EthicsEngine**: \`${{ env.EEE_REPO }}\` @ \`${{ env.EEE_BRANCH }}\`" >> $GITHUB_STEP_SUMMARY
